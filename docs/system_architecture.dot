// Palearn System Architecture Diagram
// (1) ì „ì²´ì ì¸ ì‹œìŠ¤í…œ êµ¬ì¡°
// ë Œë”ë§: dot -Tpng system_architecture.dot -o system_architecture.png

digraph PalearnSystemArchitecture {
    // ê·¸ëž˜í”„ ì „ì—­ ì„¤ì •
    rankdir=TB;
    compound=true;
    fontname="Helvetica";
    fontsize=14;
    splines=ortho;
    nodesep=0.8;
    ranksep=1.0;

    // ë…¸ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼
    node [shape=box, style="rounded,filled", fontname="Helvetica", fontsize=11];
    edge [fontname="Helvetica", fontsize=9];

    // ===== í´ë¼ì´ì–¸íŠ¸ ë ˆì´ì–´ =====
    subgraph cluster_client {
        label="ðŸ“± Flutter Mobile App (Frontend)";
        style="rounded,filled";
        fillcolor="#E3F2FD";
        color="#1976D2";
        fontsize=13;
        fontcolor="#1976D2";

        // ìŠ¤í¬ë¦° ê·¸ë£¹
        subgraph cluster_screens {
            label="Screens (UI Layer)";
            style="rounded,filled";
            fillcolor="#BBDEFB";
            color="#1565C0";

            // ì¸ì¦ ê´€ë ¨ ìŠ¤í¬ë¦°
            subgraph cluster_auth_screens {
                label="Auth Screens";
                style="rounded";
                fillcolor="#E1F5FE";
                splash [label="SplashScreen\n(splash_a.dart)", fillcolor="#FFFFFF"];
                launch [label="LaunchScreen\n(launch_b_screen.dart)", fillcolor="#FFFFFF"];
                login [label="LoginScreen\n(login_screen.dart)", fillcolor="#FFFFFF"];
                signup [label="SignUpScreen\n(signup_screen.dart)", fillcolor="#FFFFFF"];
            }

            // ë©”ì¸ ê¸°ëŠ¥ ìŠ¤í¬ë¦°
            subgraph cluster_main_screens {
                label="Main Feature Screens";
                style="rounded";
                fillcolor="#E1F5FE";
                home [label="HomeScreen\n(home_screen.dart)", fillcolor="#FFFFFF"];
                quiz [label="QuizScreen\n(quiz_screen.dart)", fillcolor="#FFFFFF"];
                quiz_result [label="QuizResultScreen\n(quiz_result_screen.dart)", fillcolor="#FFFFFF"];
                recommend_loading [label="RecommendLoadingScreen\n(recommend_loading_screen.dart)", fillcolor="#FFFFFF"];
                recommend [label="RecommendCoursesScreen\n(recommend_courses_screen.dart)", fillcolor="#FFFFFF"];
            }

            // í•™ìŠµ ê³„íš ìŠ¤í¬ë¦°
            subgraph cluster_plan_screens {
                label="Plan Screens";
                style="rounded";
                fillcolor="#E1F5FE";
                create_plan [label="CreatePlanScreen\n(create_plan_screen.dart)", fillcolor="#FFFFFF"];
                loading_plan [label="LoadingPlanScreen\n(loading_plan_screen.dart)", fillcolor="#FFFFFF"];
                plan_detail [label="PlanDetailScreen\n(plan_detail_screen.dart)", fillcolor="#FFFFFF"];
                review [label="ReviewScreen\n(review_screen.dart)", fillcolor="#FFFFFF"];
            }

            // ì†Œì…œ ê¸°ëŠ¥ ìŠ¤í¬ë¦°
            subgraph cluster_social_screens {
                label="Social Screens";
                style="rounded";
                fillcolor="#E1F5FE";
                friends [label="FriendsScreen\n(friends_screen.dart)", fillcolor="#FFFFFF"];
                friend_detail [label="FriendDetailScreen\n(friend_detail_screen.dart)", fillcolor="#FFFFFF"];
                notifications [label="NotificationsScreen\n(notifications_screen.dart)", fillcolor="#FFFFFF"];
                profile [label="ProfileScreen\n(profile_screen.dart)", fillcolor="#FFFFFF"];
                profile_edit [label="ProfileEditScreen\n(profile_edit_screen.dart)", fillcolor="#FFFFFF"];
            }
        }

        // ë°ì´í„° ë ˆì´ì–´
        subgraph cluster_data_layer {
            label="Data Layer";
            style="rounded,filled";
            fillcolor="#BBDEFB";
            color="#1565C0";

            api_service [label="ApiService\n(api_service.dart)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ AuthService\nâ€¢ ProfileService\nâ€¢ HomeService\nâ€¢ QuizService\nâ€¢ RecommendService\nâ€¢ PlanService\nâ€¢ FriendsService\nâ€¢ NotificationService\nâ€¢ ReviewService", shape=component, fillcolor="#FFF9C4"];
            quiz_repo [label="QuizRepository\n(quiz_repository.dart)", fillcolor="#FFFFFF"];
            quiz_mock [label="QuizRepositoryMock\n(quiz_repository_mock.dart)", fillcolor="#FFFFFF"];
        }
    }

    // ===== í†µì‹  ë ˆì´ì–´ =====
    subgraph cluster_communication {
        label="ðŸ”„ Communication Layer";
        style="rounded,filled";
        fillcolor="#FFF3E0";
        color="#E65100";
        fontsize=13;
        fontcolor="#E65100";

        http [label="HTTP/REST API\n(JSON)", shape=ellipse, fillcolor="#FFE0B2"];
        bearer_token [label="Bearer Token\nAuthentication", shape=ellipse, fillcolor="#FFE0B2"];
    }

    // ===== ë°±ì—”ë“œ ë ˆì´ì–´ =====
    subgraph cluster_backend {
        label="âš™ï¸ FastAPI Backend Server";
        style="rounded,filled";
        fillcolor="#E8F5E9";
        color="#388E3C";
        fontsize=13;
        fontcolor="#388E3C";

        // ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜
        main_app [label="main.py\n(FastAPI Application)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ CORS Middleware\nâ€¢ Router Registration\nâ€¢ Uvicorn Server", shape=component, fillcolor="#C8E6C9"];

        // ë¼ìš°í„° ê·¸ë£¹
        subgraph cluster_routers {
            label="Routers (API Endpoints)";
            style="rounded,filled";
            fillcolor="#A5D6A7";
            color="#2E7D32";

            router_auth [label="/auth\n(auth.py)\nâ€¢ signup\nâ€¢ login\nâ€¢ logout", fillcolor="#FFFFFF"];
            router_profile [label="/profile\n(profile.py)\nâ€¢ me\nâ€¢ update", fillcolor="#FFFFFF"];
            router_home [label="/home\n(home.py)\nâ€¢ header", fillcolor="#FFFFFF"];
            router_quiz [label="/quiz\n(quiz.py)\nâ€¢ items\nâ€¢ grade", fillcolor="#FFFFFF"];
            router_recommend [label="/recommend\n(recommend.py)\nâ€¢ courses\nâ€¢ search_status\nâ€¢ select", fillcolor="#FFFFFF"];
            router_plans [label="/plans\n(plans.py)\nâ€¢ generate\nâ€¢ all\nâ€¢ date/{date}\nâ€¢ task/update\nâ€¢ related_materials", fillcolor="#FFFFFF"];
            router_plan_apply [label="/plan\n(plan_apply.py)\nâ€¢ apply_recommendation", fillcolor="#FFFFFF"];
            router_friends [label="/friends\n(friends.py)\nâ€¢ list\nâ€¢ add\nâ€¢ {id}/plans\nâ€¢ {id}/plans/check", fillcolor="#FFFFFF"];
            router_notifications [label="/notifications\n(notifications.py)\nâ€¢ get\nâ€¢ read", fillcolor="#FFFFFF"];
            router_review [label="/review\n(review.py)\nâ€¢ yesterday\nâ€¢ topics", fillcolor="#FFFFFF"];
        }

        // ì„œë¹„ìŠ¤ ë ˆì´ì–´
        subgraph cluster_services {
            label="Services (Business Logic)";
            style="rounded,filled";
            fillcolor="#A5D6A7";
            color="#2E7D32";

            gpt_service [label="gpt_service.py\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ generate_quiz()\nâ€¢ generate_plan()\nâ€¢ recommend_courses()\nâ€¢ search_materials()", shape=component, fillcolor="#FFF9C4"];
            web_search [label="web_search.py\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ search_youtube()\nâ€¢ search_blog()\nâ€¢ get_related_materials()", shape=component, fillcolor="#FFF9C4"];
            store [label="store.py\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ InMemoryStore\nâ€¢ Singleton Pattern", shape=component, fillcolor="#FFCDD2"];
        }

        // ëª¨ë¸ ë ˆì´ì–´
        subgraph cluster_models {
            label="Models (Pydantic Schemas)";
            style="rounded,filled";
            fillcolor="#A5D6A7";
            color="#2E7D32";

            schemas [label="schemas.py\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ Request Models\nâ€¢ Response Models\nâ€¢ Data Validation", shape=note, fillcolor="#E1BEE7"];
        }

        // ìœ í‹¸ë¦¬í‹°
        subgraph cluster_utils {
            label="Utilities";
            style="rounded";
            fillcolor="#A5D6A7";

            logger [label="logger.py\n(Structured Logging)", fillcolor="#FFFFFF"];
        }
    }

    // ===== ì™¸ë¶€ ì„œë¹„ìŠ¤ =====
    subgraph cluster_external {
        label="ðŸŒ External Services";
        style="rounded,filled";
        fillcolor="#FCE4EC";
        color="#C2185B";
        fontsize=13;
        fontcolor="#C2185B";

        openai [label="OpenAI API\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ€¢ GPT-4o\nâ€¢ GPT-5-search-api\nâ€¢ gpt-4o-search-preview", shape=cylinder, fillcolor="#FFCDD2"];
        youtube_api [label="YouTube\nData API v3", shape=cylinder, fillcolor="#FFCDD2"];
        google_search [label="Google Custom\nSearch API", shape=cylinder, fillcolor="#FFCDD2"];
    }

    // ===== ë°ì´í„° ì €ìž¥ì†Œ =====
    subgraph cluster_storage {
        label="ðŸ’¾ Data Storage (In-Memory)";
        style="rounded,filled";
        fillcolor="#F3E5F5";
        color="#7B1FA2";
        fontsize=13;
        fontcolor="#7B1FA2";

        db_users [label="users\nDict[user_id, User]", shape=cylinder, fillcolor="#E1BEE7"];
        db_plans [label="plans\nDict[user_id, List[Plan]]", shape=cylinder, fillcolor="#E1BEE7"];
        db_friends [label="friendships\nDict[user_id, List[friend_id]]", shape=cylinder, fillcolor="#E1BEE7"];
        db_notifications [label="notifications\nDict[user_id, {new, old}]", shape=cylinder, fillcolor="#E1BEE7"];
        db_tokens [label="auth_tokens\nDict[token, user_id]", shape=cylinder, fillcolor="#E1BEE7"];
        db_quiz [label="quiz_answers\nDict[user_id, List[Quiz]]", shape=cylinder, fillcolor="#E1BEE7"];
        db_friend_codes [label="friend_codes\nDict[code, user_id]", shape=cylinder, fillcolor="#E1BEE7"];
    }

    // ===== ì—°ê²° ê´€ê³„ =====

    // ìŠ¤í¬ë¦° ë„¤ë¹„ê²Œì´ì…˜ í”Œë¡œìš°
    splash -> launch [style=dashed, color="#1976D2"];
    launch -> login [style=dashed, color="#1976D2"];
    launch -> signup [style=dashed, color="#1976D2"];
    login -> home [style=dashed, color="#1976D2"];
    signup -> home [style=dashed, color="#1976D2"];

    home -> quiz [style=dashed, color="#1976D2"];
    home -> plan_detail [style=dashed, color="#1976D2"];
    home -> friends [style=dashed, color="#1976D2"];
    home -> notifications [style=dashed, color="#1976D2"];
    home -> profile [style=dashed, color="#1976D2"];
    home -> review [style=dashed, color="#1976D2"];

    quiz -> quiz_result [style=dashed, color="#1976D2"];
    quiz_result -> recommend_loading [style=dashed, color="#1976D2"];
    recommend_loading -> recommend [style=dashed, color="#1976D2"];
    recommend -> create_plan [style=dashed, color="#1976D2"];
    create_plan -> loading_plan [style=dashed, color="#1976D2"];
    loading_plan -> plan_detail [style=dashed, color="#1976D2"];

    friends -> friend_detail [style=dashed, color="#1976D2"];
    profile -> profile_edit [style=dashed, color="#1976D2"];

    // API Service ì—°ê²°
    api_service -> http [lhead=cluster_communication, color="#E65100", penwidth=2];
    http -> main_app [lhead=cluster_backend, color="#E65100", penwidth=2];

    // ë¼ìš°í„° -> ë©”ì¸ ì•± ì—°ê²°
    main_app -> router_auth [color="#388E3C"];
    main_app -> router_profile [color="#388E3C"];
    main_app -> router_home [color="#388E3C"];
    main_app -> router_quiz [color="#388E3C"];
    main_app -> router_recommend [color="#388E3C"];
    main_app -> router_plans [color="#388E3C"];
    main_app -> router_plan_apply [color="#388E3C"];
    main_app -> router_friends [color="#388E3C"];
    main_app -> router_notifications [color="#388E3C"];
    main_app -> router_review [color="#388E3C"];

    // ë¼ìš°í„° -> ì„œë¹„ìŠ¤ ì—°ê²°
    router_quiz -> gpt_service [color="#FFA000", style=dashed];
    router_recommend -> gpt_service [color="#FFA000", style=dashed];
    router_plans -> gpt_service [color="#FFA000", style=dashed];
    router_plans -> web_search [color="#FFA000", style=dashed];
    router_review -> web_search [color="#FFA000", style=dashed];
    router_review -> gpt_service [color="#FFA000", style=dashed];

    // ì„œë¹„ìŠ¤ -> ì™¸ë¶€ API ì—°ê²°
    gpt_service -> openai [color="#C2185B", penwidth=2];
    web_search -> youtube_api [color="#C2185B", penwidth=2];
    web_search -> google_search [color="#C2185B", penwidth=2];

    // Store -> ë°ì´í„° ì €ìž¥ì†Œ ì—°ê²°
    store -> db_users [color="#7B1FA2"];
    store -> db_plans [color="#7B1FA2"];
    store -> db_friends [color="#7B1FA2"];
    store -> db_notifications [color="#7B1FA2"];
    store -> db_tokens [color="#7B1FA2"];
    store -> db_quiz [color="#7B1FA2"];
    store -> db_friend_codes [color="#7B1FA2"];

    // ë¼ìš°í„° -> Store ì—°ê²°
    router_auth -> store [color="#7B1FA2", style=dotted];
    router_profile -> store [color="#7B1FA2", style=dotted];
    router_home -> store [color="#7B1FA2", style=dotted];
    router_quiz -> store [color="#7B1FA2", style=dotted];
    router_plans -> store [color="#7B1FA2", style=dotted];
    router_friends -> store [color="#7B1FA2", style=dotted];
    router_notifications -> store [color="#7B1FA2", style=dotted];

    // ë²”ë¡€
    subgraph cluster_legend {
        label="Legend";
        style="rounded";
        fillcolor="#FAFAFA";
        fontsize=11;

        leg1 [label="Screen Navigation", shape=plaintext];
        leg2 [label="HTTP Communication", shape=plaintext];
        leg3 [label="Service Call", shape=plaintext];
        leg4 [label="External API", shape=plaintext];
        leg5 [label="Data Access", shape=plaintext];

        leg1 -> leg2 [style=dashed, color="#1976D2", label="  "];
        leg2 -> leg3 [color="#E65100", penwidth=2, label="  "];
        leg3 -> leg4 [color="#FFA000", style=dashed, label="  "];
        leg4 -> leg5 [color="#C2185B", penwidth=2, label="  "];
    }
}
